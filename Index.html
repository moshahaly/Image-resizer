<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resizer Pro+</title>
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --error: #ef4444;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --card-bg: #1e293b;
                --text: #f8fafc;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            min-height: 100vh;
            background: var(--background);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--background) 0%, #0f172a 100%);
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .drop-zone {
            border: 2px dashed #94a3b8;
            border-radius: 1rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            position: relative;
            background: rgba(99, 102, 241, 0.05);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .quality-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .preview-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add remaining styles from previous version and enhance as needed */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Image Resizer Pro+</h1>
            <p>Advanced Image Processing PWA</p>
        </div>

        <div class="drop-zone" id="dropZone">
            <input type="file" id="fileInput" accept="image/*" multiple hidden>
            <p>Drag & drop images or click to upload</p>
            <small>Supported formats: JPEG, PNG, WEBP, GIF, BMP</small>
        </div>

        <div class="controls">
            <div>
                <input type="number" id="widthInput" placeholder="Width (px)" min="1">
                <input type="number" id="heightInput" placeholder="Height (px)" min="1">
            </div>
            <div class="quality-controls">
                <input type="range" id="qualityInput" min="0" max="1" step="0.1" value="0.9">
                <span>Quality: <span id="qualityValue">90%</span></span>
            </div>
            <div>
                <button id="resizeButton">Resize Selected</button>
                <button id="batchButton">Process Batch</button>
            </div>
        </div>

        <div class="preview-grid" id="previewGrid"></div>
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <script>
        // Enhanced Image Processor Class
        class ImageProcessor {
            constructor() {
                this.files = [];
                this.queue = [];
                this.processing = false;
            }

            async addFiles(files) {
                const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/bmp'];
                const validFiles = Array.from(files).filter(file => 
                    validTypes.includes(file.type)
                );
                
                if (validFiles.length === 0) {
                    throw new Error('No valid image files selected');
                }

                this.files = [...this.files, ...validFiles];
                this.updatePreviewGrid();
            }

            async processAll() {
                if (this.processing) return;
                this.processing = true;
                
                try {
                    const zip = new JSZip();
                    
                    for (const [index, file] of this.files.entries()) {
                        const processed = await this.processFile(file);
                        zip.file(`resized-${index}-${file.name}`, processed.blob);
                    }

                    const content = await zip.generateAsync({type: 'blob'});
                    this.downloadFile(content, 'resized-images.zip');
                } catch (error) {
                    this.showError(error.message);
                } finally {
                    this.processing = false;
                }
            }

            async processFile(file) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const img = await this.loadImage(file);
                        const canvas = this.createCanvas(img);
                        const orientation = await this.getExifOrientation(file);
                        this.applyOrientation(canvas, orientation);
                        
                        const blob = await new Promise(resolve => 
                            canvas.toBlob(resolve, file.type, qualityInput.value)
                        );

                        resolve({ blob, url: URL.createObjectURL(blob) });
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            async getExifOrientation(file) {
                return new Promise(resolve => {
                    EXIF.getData(file, function() {
                        resolve(EXIF.getTag(this, 'Orientation') || 1);
                    });
                });
            }

            applyOrientation(canvas, orientation) {
                const ctx = canvas.getContext('2d');
                switch(orientation) {
                    case 2: ctx.transform(-1, 0, 0, 1, canvas.width, 0); break;
                    case 3: ctx.transform(-1, 0, 0, -1, canvas.width, canvas.height); break;
                    case 4: ctx.transform(1, 0, 0, -1, 0, canvas.height); break;
                    case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                    case 6: ctx.transform(0, 1, -1, 0, canvas.height, 0); break;
                    case 7: ctx.transform(0, -1, -1, 0, canvas.height, canvas.width); break;
                    case 8: ctx.transform(0, -1, 1, 0, 0, canvas.width); break;
                }
            }

            // Add remaining helper methods
        }

        // UI Controller Class
        class UIController {
            constructor() {
                this.initEventListeners();
            }

            initEventListeners() {
                // Add all event listeners
            }

            showError(message) {
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.textContent = message;
                document.body.appendChild(errorEl);
                setTimeout(() => errorEl.remove(), 5000);
            }

            updatePreviewGrid(files) {
                // Implement grid preview with thumbnails
            }

            // Add other UI methods
        }

        // Service Worker with Advanced Caching
        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                // Show update available notification
                            }
                        });
                    });
                } catch (error) {
                    console.error('SW registration failed:', error);
                }
            }
        };

        // Initialize the app
        const initApp = () => {
            const imageProcessor = new ImageProcessor();
            new UIController(imageProcessor);
            registerServiceWorker();
        };

        initApp();
    </script>
</body>
</html>